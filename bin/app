#!/usr/bin/env nu

def "main build" [] {
  cd $"($env.project)/app"; pnpm build
}

def "main clean" [] {
  cd $"($env.project)/app"

  rm -rf .astro dist elm-stuff node_modules
}

def "main deploy" [] {
  deploy $"($env.project)/app/dist" gh-pages
}

def "main dev" [] {
  cd $"($env.project)/app"; pnpm dev
}

def "main format" [] {
  cd $"($env.project)/app"; elm-format "src/elm" "tests" --yes
}

def "main prepare" [] {
  let src = $"($env.project)/workshop/dist"
  let out = $"($env.project)/app/public"

  # 1. Clean
  let out_css_files = glob $"($out)/index.*.css"
  rm -rf $"($out)/fonts" ...$out_css_files

  # 2. Build
  STYLE_MODE=app workshop build

  # 3. Copy
  let src_css_files = glob $"($src)/_astro/index.*.css"
  cp -r $"($src)/fonts" ...$src_css_files $out
}

def "main preview" [] {
  cd $"($env.project)/app"; pnpm preview
}

def --wrapped "main test" [...args] {
  cd $"($env.project)/app"; elm-test ...$args
}

def main [] {}

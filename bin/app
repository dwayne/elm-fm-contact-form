#!/usr/bin/env bash

### Usage: app (prepare|dev|build|preview)

set -euo pipefail

project="${project:?}"

main () {
  local cmd="${1:-}"

  cd "$project/app"

  case "$cmd" in
    prepare)
      prepare
      ;;

    dev)
      pnpm dev
      ;;

    build)
      pnpm build
      ;;

    preview)
      pnpm preview
      ;;

    "")
      show_usage
      ;;

    *)
      printf 'Error: Unknown command "%s"\n' "$cmd"
      exit 1
      ;;
  esac
}

prepare () {
  # 1. Copy public assets
  rsync -a "$project/workshop/public/" "$project/app/public/"

  # 2. Build the workshop and copy the CSS
  STYLE_MODE=app workshop build
  cp "$project"/workshop/dist/_astro/index.*.css "$project/app/public/"
}

show_usage () {
  #
  # 1. Extract lines starting with ### (doc comments)
  # 2. Strip the marker and the optional space
  #
  grep '^###' "$0" | sed -E 's/^### ?//'
  exit 0
}

main "$@"
